# 灰度测试和A/B test

> 可参考文章：https://cloud.tencent.com/developer/article/1542753

灰度发布也称为金丝雀发布，传说 17 世纪的英国矿井工人发现金丝雀对瓦斯气体非常敏感，瓦斯达到一定浓度时，金丝雀即会死亡，

但金丝雀的致死量瓦斯对人并不致死，因此金丝雀被用来当成他们的瓦斯检测工具。

互联网系统的灰度发布一般通过两种方式实现：

1. 通过分批次部署实现灰度发布
2. 通过业务规则进行灰度发布

在对系统的旧功能进行升级迭代时，第一种方式用的比较多。新功能上线时，第二种方式用的比较多。

当然，对比较重要的老功能进行较大幅度的修改时，一般也会选择按业务规则来进行发布，因为直接全量开放给所有用户风险实在太大。

## 通过分批次部署实现灰度发布

假如服务部署在 15 个实例（可能是物理机，也可能是容器）上，把这 15 个实例分为四组，

按照先后顺序，分别有 1-2-4-8 台机器，保证每次扩展时大概都是二倍的关系。

为什么要用 2 倍？这样能够保证我们不管有多少台机器，都不会把组划分得太多。

例如 1024 台机器，也就只需要 1-2-4-8-16-32-64-128-256-512 部署十次就可以全部部署完毕。

在上线时，最有效的观察手法是查看程序的错误日志，如果较明显的逻辑错误，一般错误日志的滚动速度都会有肉眼可见的增加，

这些错误也可以通过 metrics 一类的系统上报给监控系统，所以在上线过程中，也可以通过观察监控曲线，来判断是否有异常发生，

如果有异常情况，首先要做的自然就是回滚了。

## 通过业务规则进行灰度分布

常见的灰度策略有多种，较为简单的需求，例如我们的策略是要按照千分比来发布，

那么我们可以用用户 id、手机号、用户设备信息，等等，来生成一个简单的哈希值，然后再求模，用伪代码表示一下：

```go
// pass 3/1000
func passed() bool {
    key := hashFunctions(userID) % 1000
    if key <= 2 {
        return true
    }

    return false
}
```

常见的灰度发布系统会有下列规则提供选择：

1. 按城市发布
2. 按概率发布
3. 按百分比发布
4. 按白名单发布
5. 按业务线发布
6. 按 UA 发布 (APP、Web、PC)
7. 按分发渠道发布